# ProtoFlow ä¼˜åŒ–è¿›å±• - Phase 2 å®Œæˆ

## ğŸ“… å®Œæˆæ—¶é—´
2026-02-27

## âœ… Phase 2: StateWatcherï¼ˆçŠ¶æ€ç›‘å¬ç³»ç»Ÿï¼‰- 100%

### æ ¸å¿ƒæˆæœ

#### 1. StateWatcher å®ç°

**æ–‡ä»¶**: `src/core/StateWatcher.ts` (8.8KB)

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… ç›‘å¬çŠ¶æ€å˜åŒ–å¹¶è‡ªåŠ¨è§¦å‘actions
- âœ… æ”¯æŒè·¯å¾„ç²¾ç¡®åŒ¹é…å’Œé€šé…ç¬¦åŒ¹é…ï¼ˆå¦‚ `/user/*`ï¼‰
- âœ… æ”¯æŒé˜²æŠ–ï¼ˆdebounceï¼‰- é€‚åˆé¢‘ç¹å˜åŒ–
- âœ… æ”¯æŒèŠ‚æµï¼ˆthrottleï¼‰- é™åˆ¶æ‰§è¡Œé¢‘ç‡
- âœ… æ”¯æŒæ¡ä»¶æ‰§è¡Œï¼ˆconditionï¼‰
- âœ… æ”¯æŒç‰¹æ®Šå˜é‡ï¼ˆ$value, $oldValueï¼‰
- âœ… æ”¯æŒç‰¹æ®Šé€‰é¡¹ï¼ˆimmediate, onceï¼‰

**API**:
```typescript
// æ·»åŠ ç›‘å¬å™¨
stateWatcher.addWatcher('/user/name', {
  action: { type: 'showToast', toast: { message: 'åç§°å·²æ›´æ–°' } },
  debounce: 300  // é˜²æŠ–300ms
});

// é€šçŸ¥çŠ¶æ€å˜åŒ–
stateWatcher.notify('/user/name', 'æ–°åç§°', 'æ—§åç§°', context);

// ç§»é™¤ç›‘å¬å™¨
stateWatcher.removeWatcher('/user/name');
```

#### 2. ç¤ºä¾‹é…ç½®

**æ–‡ä»¶**: `examples/state-watcher-demo.json` (8.2KB)

**æ¼”ç¤ºåœºæ™¯**:
- **è´­ç‰©è½¦è‡ªåŠ¨æç¤º**: æ•°é‡å˜åŒ–1ç§’åæ˜¾ç¤ºToastï¼ˆé˜²æŠ–ï¼‰
- **VIPçŠ¶æ€åˆ‡æ¢**: åˆ‡æ¢æ—¶ç«‹å³æ˜¾ç¤ºå¼€é€š/è¿‡æœŸæç¤º
- **è¡¨å•å®æ—¶éªŒè¯**: è¾“å…¥æ—¶èŠ‚æµéªŒè¯ï¼ˆ500msï¼‰

**é…ç½®ç¤ºä¾‹**:
```json
{
  "type": "text",
  "content": { "$template": "å…± ${/cart/total} ä»¶å•†å“" },
  "watch": {
    "/cart/total": {
      "action": {
        "type": "showToast",
        "toast": {
          "message": { "$template": "è´­ç‰©è½¦å·²æ›´æ–°ï¼š${/cart/total} ä»¶" }
        }
      },
      "debounce": 1000  // é˜²æŠ–1ç§’
    }
  }
}
```

#### 3. æ¼”ç¤ºé¡µé¢

**æ–‡ä»¶**: `demo-state-watcher.html` (9.6KB)

**åŠŸèƒ½**:
- âœ… è´­ç‰©è½¦æ·»åŠ /æ¸…ç©ºæ“ä½œ
- âœ… VIPçŠ¶æ€åˆ‡æ¢
- âœ… å®æ—¶çŠ¶æ€æ˜¾ç¤º
- âœ… Watcherè§¦å‘æ—¥å¿—
- âœ… Toastæç¤ºæ˜¾ç¤º

**æ¼”ç¤ºåœ°å€**: http://localhost:8080/demo-state-watcher.html

#### 4. é›†æˆç¤ºä¾‹ä»£ç 

**æ–‡ä»¶**: `src/protoflow-state-watcher.js` (14.8KB)

**åŠŸèƒ½**:
- è‡ªåŠ¨æ”¶é›†æ‰€æœ‰ç»„ä»¶ä¸­çš„watché…ç½®
- çŠ¶æ€å˜åŒ–è‡ªåŠ¨è§¦å‘actions
- å®Œæ•´çš„è´­ç‰©è½¦äº¤äº’é€»è¾‘
- é›†æˆExpressionEvaluatorå’ŒVisibilityChecker

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. é˜²æŠ–ï¼ˆDebounceï¼‰

**åœºæ™¯**: ç”¨æˆ·å¿«é€Ÿç‚¹å‡»æ·»åŠ å•†å“

```json
{
  "watch": {
    "/cart/total": {
      "action": { "type": "showToast", ... },
      "debounce": 1000  // å»¶è¿Ÿ1ç§’æ‰§è¡Œï¼ŒæœŸé—´å¦‚æœç»§ç»­å˜åŒ–åˆ™é‡ç½®è®¡æ—¶å™¨
    }
  }
}
```

**æ•ˆæœ**: å¿«é€Ÿç‚¹å‡»3æ¬¡æ·»åŠ å•†å“ï¼Œåªåœ¨æœ€åä¸€æ¬¡æ“ä½œå1ç§’æ˜¾ç¤ºä¸€æ¬¡Toast

### 2. èŠ‚æµï¼ˆThrottleï¼‰

**åœºæ™¯**: è¡¨å•è¾“å…¥å®æ—¶éªŒè¯

```json
{
  "watch": {
    "/form/phone": {
      "action": { "type": "validatePhone" },
      "throttle": 500  // æœ€å¤šæ¯500msæ‰§è¡Œä¸€æ¬¡
    }
  }
}
```

**æ•ˆæœ**: å¿«é€Ÿè¾“å…¥æ•°å­—ï¼Œæ¯500mséªŒè¯ä¸€æ¬¡ï¼Œé¿å…é¢‘ç¹è§¦å‘

### 3. æ¡ä»¶æ‰§è¡Œ

**åœºæ™¯**: åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹è§¦å‘

```json
{
  "watch": {
    "/user/balance": {
      "condition": {
        "$value": { "$state": "/user/balance" },
        "lt": 100
      },
      "action": {
        "type": "showToast",
        "toast": { "message": "ä½™é¢ä¸è¶³" }
      }
    }
  }
}
```

**æ•ˆæœ**: ä½™é¢å°äº100æ—¶æ‰æ˜¾ç¤ºæç¤º

### 4. ç‰¹æ®Šé€‰é¡¹

**immediate**: ç«‹å³æ‰§è¡Œä¸€æ¬¡
```json
{
  "watch": {
    "/user": {
      "action": { "type": "loadUserInfo" },
      "immediate": true  // é¡µé¢åŠ è½½æ—¶ç«‹å³æ‰§è¡Œ
    }
  }
}
```

**once**: åªæ‰§è¡Œä¸€æ¬¡
```json
{
  "watch": {
    "/guide/completed": {
      "action": { "type": "showFirstTimeBonus" },
      "once": true  // ç¬¬ä¸€æ¬¡å˜ä¸ºtrueæ—¶æ‰§è¡Œï¼Œä¹‹åä¸å†æ‰§è¡Œ
    }
  }
}
```

### 5. é€šé…ç¬¦åŒ¹é…

```typescript
// ç›‘å¬æ‰€æœ‰è´­ç‰©è½¦å˜åŒ–
stateWatcher.addWatcher('/cart/*', {
  action: { type: 'updateCartUI' }
});

// ä»¥ä¸‹å˜åŒ–éƒ½ä¼šè§¦å‘ï¼š
// /cart/quantity/iphone
// /cart/quantity/macbook
// /cart/total
```

## ğŸ“Š ä»£ç ç»Ÿè®¡

| æ–‡ä»¶ | å¤§å° | è¡Œæ•° | è¯´æ˜ |
|------|------|------|------|
| StateWatcher.ts | 8.8KB | ~330 | æ ¸å¿ƒå®ç° |
| state-watcher-demo.json | 8.2KB | ~220 | ç¤ºä¾‹é…ç½® |
| protoflow-state-watcher.js | 14.8KB | ~440 | é›†æˆç¤ºä¾‹ |
| demo-state-watcher.html | 9.6KB | ~290 | æ¼”ç¤ºé¡µé¢ |
| **æ€»è®¡** | **41.4KB** | **~1,280** | - |

## ğŸ¨ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: ç®€å•ç›‘å¬

```json
{
  "type": "text",
  "content": { "$state": "/user/name" },
  "watch": {
    "/user/name": {
      "action": {
        "type": "showToast",
        "toast": { "message": "åç§°å·²æ›´æ–°" }
      }
    }
  }
}
```

### ç¤ºä¾‹2: é˜²æŠ–ç›‘å¬

```json
{
  "type": "input",
  "value": { "$bindState": "/search/query" },
  "watch": {
    "/search/query": {
      "action": {
        "type": "search",
        "params": { "query": { "$state": "/search/query" } }
      },
      "debounce": 500
    }
  }
}
```

### ç¤ºä¾‹3: æ¡ä»¶ç›‘å¬

```json
{
  "watch": {
    "/order/status": {
      "condition": {
        "$value": { "$state": "/order/status" },
        "eq": "completed"
      },
      "action": {
        "type": "showToast",
        "toast": { "message": "è®¢å•å·²å®Œæˆ" }
      }
    }
  }
}
```

### ç¤ºä¾‹4: é€šé…ç¬¦ç›‘å¬

```json
{
  "watch": {
    "/cart/*": {
      "action": {
        "type": "updateCartSummary"
      }
    }
  }
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

1. **é˜²æŠ–æœºåˆ¶**: é¿å…é¢‘ç¹è§¦å‘ï¼Œå‡å°‘ä¸å¿…è¦çš„è®¡ç®—
2. **èŠ‚æµæœºåˆ¶**: é™åˆ¶æ‰§è¡Œé¢‘ç‡ï¼Œé¿å…æ€§èƒ½é—®é¢˜
3. **é€šé…ç¬¦ä¼˜åŒ–**: é«˜æ•ˆåŒ¹é…è·¯å¾„ï¼Œå‡å°‘éå†å¼€é”€
4. **æ¡ä»¶æ£€æŸ¥**: æå‰åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡Œï¼Œé¿å…æ— æ•ˆæ“ä½œ

## ğŸ“‹ ä¸‹ä¸€æ­¥è®¡åˆ’

### Phase 3: SpecStreamCompilerï¼ˆæµå¼æ¸²æŸ“ï¼‰
- [ ] å®ç°æµå¼JSONè§£æ
- [ ] å¢é‡æ›´æ–°UI
- [ ] ä¼˜åŒ–å¤§é¡µé¢æ€§èƒ½

### Phase 4: CatalogManagerï¼ˆç»„ä»¶ç›®å½•ï¼‰
- [ ] æ ‡å‡†ç»„ä»¶å®šä¹‰
- [ ] ç»„ä»¶æ³¨å†Œæœºåˆ¶
- [ ] AI promptç”Ÿæˆ

### Phase 5: é›†æˆåˆ°ä¸»é¡¹ç›®
- [ ] æ›´æ–° React ç»„ä»¶
- [ ] æ›´æ–° Actionæ‰§è¡Œå™¨
- [ ] æ›´æ–°çŠ¶æ€ç®¡ç†

## ğŸ¯ å¯¹æ¯”

| ç‰¹æ€§ | ä¼ ç»Ÿæ–¹å¼ | StateWatcher |
|------|---------|--------------|
| çŠ¶æ€å˜åŒ–ç›‘å¬ | æ‰‹åŠ¨åœ¨setterä¸­è°ƒç”¨ | å£°æ˜å¼é…ç½® |
| é˜²æŠ–/èŠ‚æµ | éœ€è¦è‡ªå·±å®ç° | å†…ç½®æ”¯æŒ |
| æ¡ä»¶æ‰§è¡Œ | éœ€è¦æ‰‹åŠ¨åˆ¤æ–­ | å†…ç½®æ”¯æŒ |
| ä»£ç å¤æ‚åº¦ | é«˜ | ä½ |
| å¯ç»´æŠ¤æ€§ | å·® | ä¼˜ç§€ |

## ğŸ’¡ å…³é”®ä¼˜åŠ¿

1. **å£°æ˜å¼** - é…ç½®é©±åŠ¨ï¼Œæ— éœ€æ‰‹å†™ç›‘å¬é€»è¾‘
2. **è‡ªåŠ¨åŒ–** - çŠ¶æ€å˜åŒ–è‡ªåŠ¨è§¦å‘ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨
3. **é«˜æ€§èƒ½** - å†…ç½®é˜²æŠ–/èŠ‚æµï¼Œé¿å…æ€§èƒ½é—®é¢˜
4. **æ˜“æ‰©å±•** - æ”¯æŒè‡ªå®šä¹‰actionå’Œæ¡ä»¶
5. **æ˜“è°ƒè¯•** - å®Œæ•´çš„æ—¥å¿—å’Œç›‘æ§

## ğŸ‰ æˆæœæ€»ç»“

Phase 2 å®Œæˆäº†çŠ¶æ€ç›‘å¬ç³»ç»Ÿçš„å®ç°ï¼Œä¸º ProtoFlow æ·»åŠ äº†å“åº”å¼èƒ½åŠ›ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ç®€å•çš„JSONé…ç½®å®ç°çŠ¶æ€ç›‘å¬å’Œè‡ªåŠ¨è§¦å‘actionsï¼Œå¤§å¤§ç®€åŒ–äº†å¼€å‘å·¥ä½œã€‚

---

ğŸ¦ **å½“å‰è¿›åº¦: 40% (2/5)**
- âœ… Phase 1: ExpressionEvaluator & VisibilityChecker
- âœ… Phase 2: StateWatcher
- â³ Phase 3: SpecStreamCompiler
- â³ Phase 4: CatalogManager
- â³ Phase 5: é›†æˆåˆ°ä¸»é¡¹ç›®
