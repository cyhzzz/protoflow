<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProtoFlow - StateWatcher çŠ¶æ€ç›‘å¬æ¼”ç¤º</title>
    <link rel="stylesheet" href="src/design-system.css">
    <style>
        .demo-controls {
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .demo-controls button {
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .demo-state {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 4px;
            padding: 12px;
            margin-top: 12px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .demo-state h4 {
            margin-top: 0;
            color: #1890ff;
        }
        .log-container {
            background: #fffbe6;
            border: 1px solid #ffe58f;
            border-radius: 4px;
            padding: 12px;
            margin-top: 12px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 4px 0;
            padding: 4px 0;
            border-bottom: 1px solid #ffe58f;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-time {
            color: #8c8c8c;
            font-size: 12px;
        }
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .toast.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>ğŸ¯ ProtoFlow - StateWatcher çŠ¶æ€ç›‘å¬æ¼”ç¤º</h1>
        <p>å±•ç¤ºçŠ¶æ€å˜åŒ–è‡ªåŠ¨è§¦å‘actionsçš„åŠŸèƒ½</p>

        <!-- æ¼”ç¤ºæ§åˆ¶åŒº -->
        <div class="demo-controls">
            <h3>æ¼”ç¤ºæ§åˆ¶</h3>
            <div style="margin-bottom: 12px;">
                <strong>è´­ç‰©è½¦æ“ä½œï¼š</strong>
                <button class="btn btn--primary" onclick="addToCart('iphone')">+ iPhone</button>
                <button class="btn btn--primary" onclick="addToCart('macbook')">+ MacBook</button>
                <button class="btn btn--primary" onclick="addToCart('airpods')">+ AirPods</button>
                <button class="btn btn--secondary" onclick="clearCart()">æ¸…ç©ºè´­ç‰©è½¦</button>
            </div>
            <div style="margin-bottom: 12px;">
                <strong>VIPçŠ¶æ€ï¼š</strong>
                <button class="btn btn--secondary" onclick="toggleVip()">åˆ‡æ¢VIP</button>
            </div>
            <div>
                <strong>å…¶ä»–æ“ä½œï¼š</strong>
                <button class="btn btn--secondary" onclick="resetState()">é‡ç½®çŠ¶æ€</button>
            </div>

            <div class="demo-state">
                <h4>å½“å‰çŠ¶æ€ï¼ˆå®æ—¶ï¼‰</h4>
                <pre id="state-display"></pre>
            </div>

            <div class="log-container">
                <h4>Watcher è§¦å‘æ—¥å¿—</h4>
                <div id="log-display"></div>
            </div>
        </div>

        <!-- æ‰‹æœºæ ·æœº -->
        <div class="main-content">
            <div class="phone-section">
                <h2>è´­ç‰©è½¦æ¼”ç¤º</h2>
                <div class="phone">
                    <div class="status-bar">
                        <div class="status-bar__time" id="status-time">9:41</div>
                        <div class="status-bar__icons">
                            <span class="status-bar__icon">5G</span>
                            <span class="status-bar__icon">ğŸ”‹</span>
                        </div>
                    </div>
                    <div class="nav-bar">
                        <div class="nav-bar__title">è´­ç‰©è½¦</div>
                    </div>
                    <div class="phone-content" id="phone-content">
                        <!-- åŠ¨æ€å†…å®¹ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast æç¤º -->
        <div id="toast" class="toast"></div>

        <!-- åŠŸèƒ½è¯´æ˜ -->
        <div class="info-card">
            <h3>âœ¨ StateWatcher åŠŸèƒ½è¯´æ˜</h3>
            <h4>1. è‡ªåŠ¨è§¦å‘Actions</h4>
            <ul>
                <li>çŠ¶æ€å˜åŒ–è‡ªåŠ¨è§¦å‘æŒ‡å®šçš„action</li>
                <li>æ”¯æŒè·¯å¾„ç²¾ç¡®åŒ¹é…å’Œé€šé…ç¬¦åŒ¹é…</li>
                <li>å¯ä»¥ç›‘å¬æ·±è·¯å¾„å˜åŒ–ï¼ˆå¦‚ /cart/quantity/iphoneï¼‰</li>
            </ul>

            <h4>2. é˜²æŠ–å’ŒèŠ‚æµ</h4>
            <ul>
                <li><code>debounce</code> - é˜²æŠ–ï¼Œå»¶è¿Ÿæ‰§è¡Œï¼ˆé€‚åˆé¢‘ç¹å˜åŒ–ï¼‰</li>
                <li><code>throttle</code> - èŠ‚æµï¼Œé™åˆ¶æ‰§è¡Œé¢‘ç‡</li>
            </ul>

            <h4>3. æ¡ä»¶æ‰§è¡Œ</h4>
            <ul>
                <li><code>condition</code> - åªæœ‰æ»¡è¶³æ¡ä»¶æ‰è§¦å‘</li>
                <li>æ”¯æŒ $value å’Œ $oldValue ç‰¹æ®Šå˜é‡</li>
            </ul>

            <h4>4. ç‰¹æ®Šé€‰é¡¹</h4>
            <ul>
                <li><code>immediate</code> - ç«‹å³æ‰§è¡Œä¸€æ¬¡</li>
                <li><code>once</code> - åªæ‰§è¡Œä¸€æ¬¡</li>
            </ul>

            <h4>5. ç¤ºä¾‹åœºæ™¯</h4>
            <ul>
                <li>è´­ç‰©è½¦æ•°é‡å˜åŒ– â†’ æ˜¾ç¤ºToastæç¤º</li>
                <li>VIPçŠ¶æ€å˜åŒ– â†’ æ˜¾ç¤ºå¼€é€š/è¿‡æœŸæç¤º</li>
                <li>è¡¨å•è¾“å…¥ â†’ å®æ—¶éªŒè¯</li>
            </ul>
        </div>
    </div>

    <script src="src/core/ExpressionEvaluator.js"></script>
    <script src="src/core/VisibilityChecker.js"></script>
    <script src="src/core/StateWatcher.js"></script>
    <script src="src/protoflow-state-watcher.js"></script>
    <script>
        // çŠ¶æ€ç®¡ç†
        let appState = {
            cart: {
                quantity: {
                    iphone: 0,
                    macbook: 0,
                    airpods: 0
                },
                total: 0
            },
            user: {
                vip: false
            },
            form: {
                phone: ''
            }
        };

        // æ—¥å¿—ç³»ç»Ÿ
        const logEntries = [];

        function addLog(message) {
            const now = new Date();
            const time = now.toLocaleTimeString('zh-CN');
            const entry = `<div class="log-entry"><span class="log-time">[${time}]</span> ${message}</div>`;
            logEntries.push(entry);
            if (logEntries.length > 50) {
                logEntries.shift();
            }
            document.getElementById('log-display').innerHTML = logEntries.join('');
            document.getElementById('log-display').scrollTop = document.getElementById('log-display').scrollHeight;
        }

        // Toast æç¤º
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStateDisplay() {
            const display = document.getElementById('state-display');
            display.textContent = JSON.stringify(appState, null, 2);
        }

        // æ·»åŠ åˆ°è´­ç‰©è½¦
        function addToCart(item) {
            appState.cart.quantity[item]++;
            appState.cart.total++;
            updateStateDisplay();

            // æ·»åŠ æ—¥å¿—
            addLog(`ğŸ“¦ æ·»åŠ  ${item}ï¼Œå½“å‰æ€»æ•°ï¼š${appState.cart.total}`);

            // æ¨¡æ‹ŸçŠ¶æ€å˜åŒ–é€šçŸ¥ï¼ˆå®é™…ç”± StateWatcher å¤„ç†ï¼‰
            if (window.stateWatcher) {
                window.stateWatcher.notify('/cart', appState.cart);
            }
        }

        // æ¸…ç©ºè´­ç‰©è½¦
        function clearCart() {
            appState.cart.quantity = {
                iphone: 0,
                macbook: 0,
                airpods: 0
            };
            appState.cart.total = 0;
            updateStateDisplay();
            addLog(`ğŸ—‘ï¸ æ¸…ç©ºè´­ç‰©è½¦`);

            if (window.stateWatcher) {
                window.stateWatcher.notify('/cart', appState.cart);
            }
        }

        // åˆ‡æ¢VIP
        function toggleVip() {
            const oldVip = appState.user.vip;
            appState.user.vip = !appState.user.vip;
            updateStateDisplay();

            const message = appState.user.vip ? 'ğŸ‰ å¼€é€šVIP' : 'ğŸ˜¢ VIPè¿‡æœŸ';
            addLog(`ğŸ’ VIPçŠ¶æ€: ${appState.user.vip ? 'VIPä¼šå‘˜' : 'æ™®é€šä¼šå‘˜'}`);
            showToast(message);

            if (window.stateWatcher) {
                window.stateWatcher.notify('/user/vip', appState.user.vip, oldVip);
            }
        }

        // é‡ç½®çŠ¶æ€
        function resetState() {
            appState = {
                cart: {
                    quantity: {
                        iphone: 0,
                        macbook: 0,
                        airpods: 0
                    },
                    total: 0
                },
                user: {
                    vip: false
                },
                form: {
                    phone: ''
                }
            };
            updateStateDisplay();
            addLog(`ğŸ”„ çŠ¶æ€å·²é‡ç½®`);
        }

        // æ›´æ–°æ—¶é—´
        function updateTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const time = `${hours}:${minutes}`;
            document.getElementById('status-time').textContent = time;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateStateDisplay();
            updateTime();
            setInterval(updateTime, 60000);

            addLog('ğŸš€ StateWatcher æ¼”ç¤ºå·²å¯åŠ¨');
        });
    </script>
</body>
</html>
